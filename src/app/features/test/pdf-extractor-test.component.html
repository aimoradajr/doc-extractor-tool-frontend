<div class="max-w-6xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm border p-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">
      PDF Extraction Accuracy Test
    </h1>
    <p class="text-gray-600">
      Test the accuracy of PDF extraction using preset test cases or upload your
      own files.
    </p>
  </div>

  <!-- Mode Selection -->
  <div class="bg-white rounded-lg shadow-sm border p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Test Mode</h2>
    <div class="flex space-x-4">
      <button
        class="px-4 py-2 bg-blue-600 text-white rounded-md font-medium transition-colors cursor-default"
        disabled
      >
        Preset Mode
      </button>
    </div>

    <div class="mt-4 text-sm text-gray-600">
      <p>
        Select from predefined test cases with known ground truth data for
        accuracy measurement.
      </p>
    </div>
  </div>

  <!-- Test Configuration -->
  <div class="bg-white rounded-lg shadow-sm border p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Test Configuration</h2>

    <!-- Preset Mode -->
    <div class="space-y-4">
      <div>
        <label
          for="preset-select"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Select Test Preset
        </label>
        @if (isLoadingPresets()) {
        <div class="flex items-center text-gray-500">
          <div
            class="animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent mr-2"
          ></div>
          Loading presets...
        </div>
        } @else {
        <select
          id="preset-select"
          [(ngModel)]="selectedPreset"
          class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">Choose a preset...</option>
          @for (preset of presetOptions(); track preset.id) {
          <option [value]="preset.id">
            [{{ preset.id }}] {{ preset.name }}
          </option>
          }
        </select>

        @if (selectedPreset()) { @for (preset of presetOptions(); track
        preset.id) { @if (preset.id === selectedPreset()) {
        <div class="mt-2 text-sm text-gray-600 space-y-1">
          <p><strong>PDF File:</strong> {{ preset.pdfFile }}</p>
          <p><strong>Ground Truth:</strong> {{ preset.groundTruthFile }}</p>
        </div>
        } } } }
      </div>
    </div>

    <!-- Error Message -->
    @if (errorMessage()) {
    <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
      <p class="text-red-700 text-sm">{{ errorMessage() }}</p>
    </div>
    }

    <!-- Run Test Button -->
    <div class="mt-6">
      <button
        (click)="runTest()"
        [disabled]="isLoading() || !selectedPreset()"
        [class]="
          isLoading() || !selectedPreset()
            ? 'bg-gray-300 cursor-not-allowed'
            : 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500'
        "
        class="inline-flex items-center px-6 py-2 border border-transparent text-base font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors"
      >
        @if (isLoading()) {
        <div
          class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"
        ></div>
        Running Test... } @else { Run Accuracy Test }
      </button>
    </div>
  </div>

  <!-- Test Results -->
  @if (testResult()) {
  <div class="space-y-6">
    <!-- Test Overview -->
    <div class="bg-white rounded-lg shadow-sm border p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Test Results</h2>
      <div class="space-y-3">
        <div class="flex">
          <div class="w-1/3 text-sm text-gray-600">Test Case:</div>
          <div class="w-2/3 font-medium text-gray-900">
            {{ testResult()!.testCase }}
          </div>
        </div>
        <div class="flex">
          <div class="w-1/3 text-sm text-gray-600">Extract AI Model:</div>
          <div class="w-2/3 font-medium text-gray-900">
            {{ testResult()!.extract_ai_model || "N/A" }}
          </div>
        </div>
        <div class="flex">
          <div class="w-1/3 text-sm text-gray-600">Compare Mode:</div>
          <div class="w-2/3 font-medium text-gray-900">
            {{ testResult()!.compare_mode || "N/A" }}
          </div>
        </div>
        <div class="flex">
          <div class="w-1/3 text-sm text-gray-600">Compare AI Model:</div>
          <div class="w-2/3 font-medium text-gray-900">
            {{ testResult()!.compare_ai_model || "N/A" }}
          </div>
        </div>
      </div>
    </div>

    <!-- Overall Metrics -->
    <div class="bg-white rounded-lg shadow-sm border p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Overall Metrics</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div
          class="text-center p-4 bg-gray-50 rounded-lg cursor-help"
          title="Precision: The percentage of extracted items that are actually correct."
        >
          <p
            class="text-2xl font-bold"
            [class]="getMetricColor(testResult()!.metrics.precision)"
          >
            {{ formatPercentage(testResult()!.metrics.precision) }}
          </p>
          <p class="text-sm text-gray-600">Precision</p>
        </div>
        <div
          class="text-center p-4 bg-gray-50 rounded-lg cursor-help"
          title="Recall: The percentage of actual items that were successfully extracted."
        >
          <p
            class="text-2xl font-bold"
            [class]="getMetricColor(testResult()!.metrics.recall)"
          >
            {{ formatPercentage(testResult()!.metrics.recall) }}
          </p>
          <p class="text-sm text-gray-600">Recall</p>
        </div>
        <div
          class="text-center p-4 bg-gray-50 rounded-lg cursor-help"
          title="F1 Score: The balanced average of precision and recall."
        >
          <p
            class="text-2xl font-bold"
            [class]="getMetricColor(testResult()!.metrics.f1Score)"
          >
            {{ formatPercentage(testResult()!.metrics.f1Score) }}
          </p>
          <p class="text-sm text-gray-600">F1 Score</p>
        </div>
      </div>
    </div>

    <!-- Detailed Metrics by Category -->
    <div class="bg-white rounded-lg shadow-sm border p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Detailed Metrics</h3>
      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6"
      >
        <!-- Goals -->
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-3">Goals</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Precision:</span>
              <span
                [class]="getMetricColor(testResult()!.details.goals.precision)"
              >
                {{ formatPercentage(testResult()!.details.goals.precision) }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Recall:</span>
              <span
                [class]="getMetricColor(testResult()!.details.goals.recall)"
              >
                {{ formatPercentage(testResult()!.details.goals.recall) }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>F1 Score:</span>
              <span
                [class]="getMetricColor(testResult()!.details.goals.f1Score)"
              >
                {{ formatPercentage(testResult()!.details.goals.f1Score) }}
              </span>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              {{ testResult()!.details.goals.correctCount }} correct /
              {{ testResult()!.details.goals.totalExtracted }} extracted /
              {{ testResult()!.details.goals.totalExpected }} expected
            </div>
          </div>
        </div>

        <!-- BMPs -->
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-3">BMPs</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Precision:</span>
              <span
                [class]="getMetricColor(testResult()!.details.bmps.precision)"
              >
                {{ formatPercentage(testResult()!.details.bmps.precision) }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Recall:</span>
              <span [class]="getMetricColor(testResult()!.details.bmps.recall)">
                {{ formatPercentage(testResult()!.details.bmps.recall) }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>F1 Score:</span>
              <span
                [class]="getMetricColor(testResult()!.details.bmps.f1Score)"
              >
                {{ formatPercentage(testResult()!.details.bmps.f1Score) }}
              </span>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              {{ testResult()!.details.bmps.correctCount }} correct /
              {{ testResult()!.details.bmps.totalExtracted }} extracted /
              {{ testResult()!.details.bmps.totalExpected }} expected
            </div>
          </div>
        </div>

        <!-- Implementation -->
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-3">Implementation</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Precision:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.implementation.precision)
                "
              >
                {{
                  formatPercentage(
                    testResult()!.details.implementation.precision
                  )
                }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Recall:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.implementation.recall)
                "
              >
                {{
                  formatPercentage(testResult()!.details.implementation.recall)
                }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>F1 Score:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.implementation.f1Score)
                "
              >
                {{
                  formatPercentage(testResult()!.details.implementation.f1Score)
                }}
              </span>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              {{ testResult()!.details.implementation.correctCount }} correct /
              {{ testResult()!.details.implementation.totalExtracted }}
              extracted /
              {{ testResult()!.details.implementation.totalExpected }} expected
            </div>
          </div>
        </div>

        <!-- Monitoring -->
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-3">Monitoring</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Precision:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.monitoring.precision)
                "
              >
                {{
                  formatPercentage(testResult()!.details.monitoring.precision)
                }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Recall:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.monitoring.recall)
                "
              >
                {{ formatPercentage(testResult()!.details.monitoring.recall) }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>F1 Score:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.monitoring.f1Score)
                "
              >
                {{ formatPercentage(testResult()!.details.monitoring.f1Score) }}
              </span>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              {{ testResult()!.details.monitoring.correctCount }} correct /
              {{ testResult()!.details.monitoring.totalExtracted }} extracted /
              {{ testResult()!.details.monitoring.totalExpected }} expected
            </div>
          </div>
        </div>

        <!-- Outreach -->
        @if (testResult()!.details.outreach) {
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-3">Outreach</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Precision:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.outreach!.precision)
                "
              >
                {{
                  formatPercentage(testResult()!.details.outreach!.precision)
                }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Recall:</span>
              <span
                [class]="getMetricColor(testResult()!.details.outreach!.recall)"
              >
                {{ formatPercentage(testResult()!.details.outreach!.recall) }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>F1 Score:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.outreach!.f1Score)
                "
              >
                {{ formatPercentage(testResult()!.details.outreach!.f1Score) }}
              </span>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              {{ testResult()!.details.outreach!.correctCount }} correct /
              {{ testResult()!.details.outreach!.totalExtracted }} extracted /
              {{ testResult()!.details.outreach!.totalExpected }} expected
            </div>
          </div>
        </div>
        }

        <!-- Geographic Areas -->
        @if (testResult()!.details.geographicAreas) {
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-3">Geographic Areas</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Precision:</span>
              <span
                [class]="
                  getMetricColor(
                    testResult()!.details.geographicAreas!.precision
                  )
                "
              >
                {{
                  formatPercentage(
                    testResult()!.details.geographicAreas!.precision
                  )
                }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Recall:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.geographicAreas!.recall)
                "
              >
                {{
                  formatPercentage(
                    testResult()!.details.geographicAreas!.recall
                  )
                }}
              </span>
            </div>
            <div class="flex justify-between">
              <span>F1 Score:</span>
              <span
                [class]="
                  getMetricColor(testResult()!.details.geographicAreas!.f1Score)
                "
              >
                {{
                  formatPercentage(
                    testResult()!.details.geographicAreas!.f1Score
                  )
                }}
              </span>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              {{ testResult()!.details.geographicAreas!.correctCount }} correct
              /
              {{
                testResult()!.details.geographicAreas!.totalExtracted
              }}
              extracted /
              {{
                testResult()!.details.geographicAreas!.totalExpected
              }}
              expected
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Detailed Comparisons -->
    @if (testResult()!.detailedComparisons) {
    <div class="bg-white rounded-lg shadow-sm border p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        Detailed Comparisons
      </h3>

      <!-- Goals Comparisons -->
      @if (testResult()!.detailedComparisons!.goals &&
      testResult()!.detailedComparisons!.goals.length > 0) {
      <div class="mb-6">
        <h4 class="font-medium text-gray-900 mb-3">Goals</h4>
        <div class="space-y-2">
          @for (comparison of testResult()!.detailedComparisons!.goals; track
          $index) {
          <div class="border rounded-md p-3 hover:bg-gray-50 transition-colors">
            <div
              class="flex items-start space-x-2 text-sm cursor-pointer"
              (click)="toggleComparisonDetails('goals', $index)"
            >
              <span
                class="flex items-center"
                [class]="getComparisonColor(comparison.type)"
                [innerHTML]="getComparisonIcon(comparison.type)"
              ></span>
              <div class="flex-1" [class]="getComparisonColor(comparison.type)">
                <span>{{ comparison.message }}</span>
              </div>
              <span class="text-gray-400 text-xs">
                @if (isComparisonExpanded('goals', $index)) { ▼ } @else { ▶ }
              </span>
            </div>
            @if (isComparisonExpanded('goals', $index) && (comparison.expected
            || comparison.actual)) {
            <div class="mt-2 ml-6 space-y-1 text-xs text-gray-600">
              @if (comparison.expected) {
              <div>Expected: '{{ comparison.expected }}'</div>
              } @if (comparison.actual) {
              <div>Actual: '{{ comparison.actual }}'</div>
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
      }

      <!-- BMPs Comparisons -->
      @if (testResult()!.detailedComparisons!.bmps &&
      testResult()!.detailedComparisons!.bmps.length > 0) {
      <div class="mb-6">
        <h4 class="font-medium text-gray-900 mb-3">BMPs</h4>
        <div class="space-y-2">
          @for (comparison of testResult()!.detailedComparisons!.bmps; track
          $index) {
          <div class="border rounded-md p-3 hover:bg-gray-50 transition-colors">
            <div
              class="flex items-start space-x-2 text-sm cursor-pointer"
              (click)="toggleComparisonDetails('bmps', $index)"
            >
              <span
                class="flex items-center"
                [class]="getComparisonColor(comparison.type)"
                [innerHTML]="getComparisonIcon(comparison.type)"
              ></span>
              <div class="flex-1" [class]="getComparisonColor(comparison.type)">
                <span>{{ comparison.message }}</span>
              </div>
              <span class="text-gray-400 text-xs">
                @if (isComparisonExpanded('bmps', $index)) { ▼ } @else { ▶ }
              </span>
            </div>
            @if (isComparisonExpanded('bmps', $index) && (comparison.expected ||
            comparison.actual)) {
            <div class="mt-2 ml-6 space-y-1 text-xs text-gray-600">
              @if (comparison.expected) {
              <div>Expected: '{{ comparison.expected }}'</div>
              } @if (comparison.actual) {
              <div>Actual: '{{ comparison.actual }}'</div>
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
      }

      <!-- Implementation Comparisons -->
      @if (testResult()!.detailedComparisons!.implementation &&
      testResult()!.detailedComparisons!.implementation.length > 0) {
      <div class="mb-6">
        <h4 class="font-medium text-gray-900 mb-3">Implementation</h4>
        <div class="space-y-2">
          @for (comparison of testResult()!.detailedComparisons!.implementation;
          track $index) {
          <div class="border rounded-md p-3 hover:bg-gray-50 transition-colors">
            <div
              class="flex items-start space-x-2 text-sm cursor-pointer"
              (click)="toggleComparisonDetails('implementation', $index)"
            >
              <span
                class="flex items-center"
                [class]="getComparisonColor(comparison.type)"
                [innerHTML]="getComparisonIcon(comparison.type)"
              ></span>
              <div class="flex-1" [class]="getComparisonColor(comparison.type)">
                <span>{{ comparison.message }}</span>
              </div>
              <span class="text-gray-400 text-xs">
                @if (isComparisonExpanded('implementation', $index)) { ▼ } @else
                { ▶ }
              </span>
            </div>
            @if (isComparisonExpanded('implementation', $index) &&
            (comparison.expected || comparison.actual)) {
            <div class="mt-2 ml-6 space-y-1 text-xs text-gray-600">
              @if (comparison.expected) {
              <div>Expected: '{{ comparison.expected }}'</div>
              } @if (comparison.actual) {
              <div>Actual: '{{ comparison.actual }}'</div>
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
      }

      <!-- Monitoring Comparisons -->
      @if (testResult()!.detailedComparisons!.monitoring &&
      testResult()!.detailedComparisons!.monitoring.length > 0) {
      <div class="mb-6">
        <h4 class="font-medium text-gray-900 mb-3">Monitoring</h4>
        <div class="space-y-2">
          @for (comparison of testResult()!.detailedComparisons!.monitoring;
          track $index) {
          <div class="border rounded-md p-3 hover:bg-gray-50 transition-colors">
            <div
              class="flex items-start space-x-2 text-sm cursor-pointer"
              (click)="toggleComparisonDetails('monitoring', $index)"
            >
              <span
                class="flex items-center"
                [class]="getComparisonColor(comparison.type)"
                [innerHTML]="getComparisonIcon(comparison.type)"
              ></span>
              <div class="flex-1" [class]="getComparisonColor(comparison.type)">
                <span>{{ comparison.message }}</span>
              </div>
              <span class="text-gray-400 text-xs">
                @if (isComparisonExpanded('monitoring', $index)) { ▼ } @else { ▶
                }
              </span>
            </div>
            @if (isComparisonExpanded('monitoring', $index) &&
            (comparison.expected || comparison.actual)) {
            <div class="mt-2 ml-6 space-y-1 text-xs text-gray-600">
              @if (comparison.expected) {
              <div>Expected: '{{ comparison.expected }}'</div>
              } @if (comparison.actual) {
              <div>Actual: '{{ comparison.actual }}'</div>
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
      }

      <!-- Outreach Comparisons -->
      @if (testResult()!.detailedComparisons!.outreach &&
      testResult()!.detailedComparisons!.outreach!.length > 0) {
      <div class="mb-6">
        <h4 class="font-medium text-gray-900 mb-3">Outreach</h4>
        <div class="space-y-2">
          @for (comparison of testResult()!.detailedComparisons!.outreach!;
          track $index) {
          <div class="border rounded-md p-3 hover:bg-gray-50 transition-colors">
            <div
              class="flex items-start space-x-2 text-sm cursor-pointer"
              (click)="toggleComparisonDetails('outreach', $index)"
            >
              <span
                class="flex items-center"
                [class]="getComparisonColor(comparison.type)"
                [innerHTML]="getComparisonIcon(comparison.type)"
              ></span>
              <div class="flex-1" [class]="getComparisonColor(comparison.type)">
                <span>{{ comparison.message }}</span>
              </div>
              <span class="text-gray-400 text-xs">
                @if (isComparisonExpanded('outreach', $index)) { ▼ } @else { ▶ }
              </span>
            </div>
            @if (isComparisonExpanded('outreach', $index) &&
            (comparison.expected || comparison.actual)) {
            <div class="mt-2 ml-6 space-y-1 text-xs text-gray-600">
              @if (comparison.expected) {
              <div>Expected: '{{ comparison.expected }}'</div>
              } @if (comparison.actual) {
              <div>Actual: '{{ comparison.actual }}'</div>
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
      }

      <!-- Geographic Areas Comparisons -->
      @if (testResult()!.detailedComparisons!.geographicAreas &&
      testResult()!.detailedComparisons!.geographicAreas!.length > 0) {
      <div class="mb-6">
        <h4 class="font-medium text-gray-900 mb-3">Geographic Areas</h4>
        <div class="space-y-2">
          @for (comparison of
          testResult()!.detailedComparisons!.geographicAreas!; track $index) {
          <div class="border rounded-md p-3 hover:bg-gray-50 transition-colors">
            <div
              class="flex items-start space-x-2 text-sm cursor-pointer"
              (click)="toggleComparisonDetails('geographicAreas', $index)"
            >
              <span
                class="flex items-center"
                [class]="getComparisonColor(comparison.type)"
                [innerHTML]="getComparisonIcon(comparison.type)"
              ></span>
              <div class="flex-1" [class]="getComparisonColor(comparison.type)">
                <span>{{ comparison.message }}</span>
              </div>
              <span class="text-gray-400 text-xs">
                @if (isComparisonExpanded('geographicAreas', $index)) { ▼ }
                @else { ▶ }
              </span>
            </div>
            @if (isComparisonExpanded('geographicAreas', $index) &&
            (comparison.expected || comparison.actual)) {
            <div class="mt-2 ml-6 space-y-1 text-xs text-gray-600">
              @if (comparison.expected) {
              <div>Expected: '{{ comparison.expected }}'</div>
              } @if (comparison.actual) {
              <div>Actual: '{{ comparison.actual }}'</div>
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
      }
    </div>
    }

    <!-- Actions -->
    <div class="bg-white rounded-lg shadow-sm border p-6">
      <div class="flex space-x-4">
        <button
          (click)="reset()"
          class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md font-medium transition-colors"
        >
          Run Another Test
        </button>
      </div>
    </div>
  </div>
  }
</div>
